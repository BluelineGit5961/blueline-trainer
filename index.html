
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Blueline SOP Trainer ‚Äî Standalone</title>
<style>
  :root { --bg:#f7fafc; --card:#fff; --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; }
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(#f8fafc,#eef2f7);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1000px;margin:28px auto;padding:16px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:12px 16px;box-shadow:0 2px 8px rgba(15,23,42,.06)}
  .bar select,.bar button,.bar label{font-size:14px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(15,23,42,.06)}
  .title{font-weight:700;font-size:20px;margin:0 0 8px}
  .step-title{font-weight:600;font-size:18px;margin:0 0 8px}
  .prose{color:var(--ink);line-height:1.5}
  .prose img{max-width:100%;border-radius:12px}
  .prose figure{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;margin:0}
  .prose figcaption{font-size:12px;color:var(--muted);padding:6px 10px}
  .grid{display:grid;gap:12px}
  @media(min-width:700px){.grid-2{grid-template-columns:1fr 1fr}}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;width:220px}
  .progress>div{height:100%;background:var(--accent);width:0}
  .steps ol{margin:0;padding-left:20px}
  .steps li{cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .sr-only{position:absolute;left:-9999px}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="controls">
      <strong>SOP Trainer</strong>
      <span class="muted">Standalone ‚Ä¢ Multi‚Äëprogram ‚Ä¢ i18n ‚Ä¢ Browser TTS</span>
    </div>
    <div class="controls">
      <label class="sr-only" for="program">Program</label>
      <select id="program"></select>
      <label class="sr-only" for="lang">Language</label>
      <select id="lang"></select>
      <label class="btn" style="margin-left:4px;display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        <span>Upload JSON</span>
        <input id="jsonfile" type="file" accept="application/json" class="sr-only">
      </label>
      <label style="display:inline-flex;gap:6px;align-items:center;margin-left:6px;font-size:13px">
        <input id="autotts" type="checkbox"> Auto‚Äëspeak
      </label>
    </div>
  </div>

  <div id="main" class="grid" style="margin-top:12px">
    <div class="card">
      <h2 id="stepTitle" class="step-title"></h2>
      <div id="stepHtml" class="prose"></div>
      <div id="stepImages" class="grid grid-2" style="margin-top:10px"></div>
      <div id="stepPrompt" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="controls" style="justify-content:space-between">
        <div class="controls">
          <button id="back" class="btn">‚Üê Back</button>
          <button id="repeat" class="btn">Repeat üîä</button>
          <button id="mic" class="btn">üé§ Mic</button>
        </div>
        <div class="controls">
          <div class="progress" aria-label="progress"><div id="bar"></div></div>
          <button id="next" class="btn primary">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <div class="card steps">
      <h3 class="title" style="font-size:16px">Steps</h3>
      <ol id="outline" class="grid grid-2"></ol>
    </div>

    <div id="completion" class="card" style="display:none">
      <h3 class="title">Training Complete üéì</h3>
      <p class="muted">Please complete the form below to confirm training completion.</p>
      <iframe id="jotform" title="Completion Form" style="width:100%;height:640px;border:1px solid #e5e7eb;border-radius:12px"></iframe>
    </div>
  </div>
</div>

<script>
/* ---------- Minimal schema (same as the React prototype) ----------
{
  "programId": "hobart-ironer-1",
  "title": "Blueline Ironer 1 SOP Trainer",
  "languages": ["en","pt"],
  "steps": [{
    "title": {"en":"Step 1","pt":"Passo 1"},
    "html": {"en":"<p>...</p>","pt":"<p>...</p>"},
    "speak":{"en":"Welcome","pt":"Bem-vindo"},
    "prompts":{"en":["Say 'next'"],"pt":["Diga 'pr√≥ximo'"]},
    "images":[{"src":"https://.../front.png","alt":{"en":"Front","pt":"Frente"}}]
  }],
  "completion":{"jotformUrl":"https://form.jotform.com/251048843614053"}
}
------------------------------------------------------------------- */

const sample = {
  programId: "hobart-ironer-1",
  title: "Blueline Ironer 1 SOP Trainer",
  languages: ["en","pt"],
  steps: [
    {
      title: {en:"Step 1: Introduction", pt:"Passo 1: Introdu√ß√£o"},
      html: {
        en: `<p>This SOP describes safe and efficient operation of the <strong>Hobart Gas Ironer 1</strong>.</p>
             <p>It supports <strong>ISO 14001</strong> and <strong>ISO 9001</strong>.</p>`,
        pt: `<p>Este POP descreve a opera√ß√£o segura e eficiente da <strong>Hobart Gas Ironer 1</strong>.</p>
             <p>Suporta <strong>ISO 14001</strong> e <strong>ISO 9001</strong>.</p>`
      },
      speak: {en:"Welcome! Are you ready to begin?", pt:"Bem‚Äëvindo! Vamos come√ßar?"},
      prompts: {en:["Say 'next' when you're ready."], pt:["Diga 'pr√≥ximo' para continuar."]},
      images: [{src:"https://blueline-trainer-frontend.onrender.com/hob-ironer1/hobironer1front.png",alt:{en:"Front view",pt:"Vista frontal"}}]
    },
    {
      title: {en:"Step 2: PPE and Safety", pt:"Passo 2: EPI e Seguran√ßa"},
      html: {
        en: <ul><li>No loose clothing</li><li>No jewellery</li><li>Hair tied back</li></ul>,
        pt: <ul><li>Sem roupas largas</li><li>Sem joias</li><li>Cabelo preso</li></ul>
      },
      speak: {en:"Check your PPE before using the ironer.", pt:"Verifique os EPIs antes de usar a calandra."},
      prompts: {en:["Say 'next' to continue."], pt:["Diga 'pr√≥ximo' para continuar."]}
    }
  ],
  completion:{jotformUrl:"https://form.jotform.com/251048843614053"}
};

const $ = sel => document.querySelector(sel);
const programSel = $("#program");
const langSel = $("#lang");
const jsonInput = $("#jsonfile");
const bar = $("#bar");
const stepTitle = $("#stepTitle");
const stepHtml = $("#stepHtml");
const stepImages = $("#stepImages");
const stepPrompt = $("#stepPrompt");
const nextBtn = $("#next");
const backBtn = $("#back");
const repeatBtn = $("#repeat");
const micBtn = $("#mic");
const completion = $("#completion");
const jotform = $("#jotform");
const outline = $("#outline");
const autoTTS = $("#autotts");

let programs = [sample];
let pid = sample.programId;
let lang = "en";
let idx = 0;

function pickProgram() {
  return programs.find(p => p.programId === pid) || programs[0];
}
function langs() {
  const p = pickProgram();
  return (p.languages && p.languages.length) ? p.languages : ["en"];
}
function speakText(text) {
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  const pickVoice = () => {
    const voices = window.speechSynthesis.getVoices();
    const map = {en:"en-AU",pt:"pt-PT",es:"es-ES"};
    const want = map[lang] || "en-AU";
    return voices.find(v => v.lang?.toLowerCase().startsWith(want.toLowerCase())) || voices[0];
  };
  const v = pickVoice();
  if (v) utter.voice = v;
  window.speechSynthesis.speak(utter);
}
function stripHtml(html="") {
  const div = document.createElement("div"); div.innerHTML = html;
  // remove figcaptions from speak
  div.querySelectorAll("figcaption,.caption").forEach(n=>n.remove());
  return div.textContent || div.innerText || "";
}
function renderStep() {
  const p = pickProgram();
  const steps = p.steps || [];
  const done = idx >= steps.length;
  // completion screen
  completion.style.display = done ? "block" : "none";
  if (done) {
    stepTitle.textContent = "";
    stepHtml.innerHTML = "";
    stepImages.innerHTML = "";
    stepPrompt.textContent = "";
    jotform.src = p.completion?.jotformUrl || "";
    bar.style.width = "100%";
    return;
  }
  const s = steps[idx];
  stepTitle.textContent = s.title?.[lang] || s.title?.en || Step ${idx+1};
  stepHtml.innerHTML = s.html?.[lang] || s.html?.en || "";
  stepImages.innerHTML = (Array.isArray(s.images)? s.images:[]).map(im => `
    <figure><img src="${im.src}" loading="lazy" alt="${(im.alt?.[lang]||im.alt?.en||'')}" />
      <figcaption>${im.alt?.[lang]||im.alt?.en||''}</figcaption>
    </figure>`).join("");
  const prompt = Array.isArray(s.prompts?.[lang]) && s.prompts[lang][0] ? s.prompts[lang][0] : "";
  stepPrompt.textContent = prompt;
  const pct = steps.length ? ((idx+1)/steps.length)*100 : 0;
  bar.style.width = pct + "%";
  // outline
  outline.innerHTML = steps.map((st,i)=><li data-i="${i}" style="${i===idx?'font-weight:600':''}">${st.title?.[lang]||st.title?.en||('Step '+(i+1))}</li>).join("");
  outline.querySelectorAll("li").forEach(li => li.onclick = () => { idx = Number(li.dataset.i); renderStep(); });
  if (autoTTS.checked) speakText( s.speak?.[lang] || stripHtml(s.html?.[lang] || s.html?.en || "") );
}
function populateSelectors() {
  // programs
  programSel.innerHTML = programs.map(p=><option value="${p.programId}">${p.title}</option>).join("");
  programSel.value = pid;
  // langs
  const ls = langs();
  langSel.innerHTML = ls.map(l=><option value="${l}">${({"en":"English","pt":"Portugu√™s","es":"Espa√±ol"})[l]||l.toUpperCase()}</option>).join("");
  if (!ls.includes(lang)) lang = ls[0]; langSel.value = lang;
}
programSel.onchange = () => { pid = programSel.value; idx=0; populateSelectors(); renderStep(); saveState(); };
langSel.onchange = () => { lang = langSel.value; renderStep(); saveState(); };
jsonInput.onchange = ev => {
  const f = ev.target.files?.[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      const arr = Array.isArray(data) ? data : [data];
      const map = new Map(programs.map(p=>[p.programId,p]));
      arr.forEach(p => { if (p?.programId) map.set(p.programId,p); });
      programs = Array.from(map.values());
      pid = programs[programs.length-1].programId; idx=0;
      populateSelectors(); renderStep(); saveState();
      alert("Program(s) loaded.");
    } catch(e) { alert("Invalid JSON."); }
  };
  reader.readAsText(f);
};
nextBtn.onclick = () => { const p = pickProgram(); const n = (p.steps||[]).length; idx = Math.min(idx+1,n); renderStep(); saveState(); };
backBtn.onclick = () => { idx = Math.max(idx-1,0); renderStep(); saveState(); };
repeatBtn.onclick = () => {
  const p = pickProgram(); const s = (p.steps||[])[idx]; if (!s) return;
  speakText( s.speak?.[lang] || stripHtml(s.html?.[lang] || s.html?.en || "") );
};
micBtn.onclick = () => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("SpeechRecognition not supported in this browser."); return; }
  const r = new SR();
  const map = {en:"en-AU",pt:"pt-PT",es:"es-ES"};
  r.lang = (map[lang]||"en-AU");
  r.interimResults = false; r.maxAlternatives = 1;
  r.onresult = e => {
    const t = e.results?.[0]?.[0]?.transcript?.toLowerCase() || "";
    if (/(next|continue|proceed|ok|okay|let's go|pr√≥ximo|siguiente)/.test(t)) nextBtn.click();
    else if (/(repeat|again|repetir)/.test(t)) repeatBtn.click();
    else speakText("Sorry, say next or repeat.");
  };
  r.start();
};
function saveState() {
  localStorage.setItem("sop_state", JSON.stringify({pid,lang,idx,auto:autoTTS.checked}));
}
function loadState() {
  try { const s = JSON.parse(localStorage.getItem("sop_state")||"{}");
    if (s.pid) pid=s.pid; if (s.lang) lang=s.lang; if (Number.isFinite(s.idx)) idx=s.idx;
    autoTTS.checked = !!s.auto;
  } catch {}
}
window.addEventListener("load", () => { loadState(); populateSelectors(); renderStep(); });
</script>
</body>
</html>
HTML
